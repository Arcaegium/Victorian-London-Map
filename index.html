<!DOCTYPE html>
<html>
<head>
  <title>Victorian London Map (Interactive)</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.awesome-markers@2.0.4/dist/leaflet.awesome-markers.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    .leaflet-top.leaflet-right { top: 70px; }
    #exportBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      padding: 6px 10px;
      background: white;
      border: 1px solid #666;
      font-size: 14px;
      cursor: pointer;
    }
    #typeSelector, #visibilityToggle {
      position: absolute;
      top: 10px;
      z-index: 1000;
      background: white;
      border: 1px solid #666;
      padding: 5px;
      font-size: 14px;
    }
    #typeSelector { left: 60px; }
    #visibilityToggle { left: 200px; }
    .legend {
      background: white;
      padding: 6px 8px;
      font: 14px Arial, sans-serif;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      line-height: 24px;
    }
    .legend i {
      width: 16px;
      height: 16px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
    }
  </style>
</head>
<body>
  <div id="ownerControls" style="display:none;">
    <select id="typeSelector">
      <option value="alchemicals">alchemicals</option>
      <option value="campsite">campsite</option>
      <option value="concern">concern</option>
      <option value="contact">contact</option>
      <option value="district">district</option>
      <option value="doctor">doctor</option>
      <option value="electriques">electriques</option>
      <option value="mechaniques">mechaniques</option>
      <option value="performance site">performance site</option>
      <option value="rumor mill">rumor mill</option>
      <option value="ward">ward</option>
    </select>
    <select id="visibilityToggle">
      <option value="public">Public</option>
      <option value="private">Private</option>
    </select>
  </div>
  <div id="map"></div>
  <button id="exportBtn" onclick="exportGeoJSON()">Export GeoJSON</button>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.awesome-markers@2.0.4/dist/leaflet.awesome-markers.js"></script>
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>

  <script>
    const isOwner = new URLSearchParams(window.location.search).get('mode') === 'owner';
    const map = L.map('map', {
      center: [51.5074, -0.1278],
      zoom: 13,
      layers: []
    });

    // Add fallback layer first
    const fallbackLayer = L.tileLayer('https://geo.nls.uk/mapdata2/os/6_inch_gb/{z}/{x}/{y}.png', {
      minZoom: 12,
      maxZoom: 17,
      attribution: '&copy; <a href="https://maps.nls.uk/">National Library of Scotland</a>'
    }).addTo(map);

    // Add primary layer on top
    const primaryLayer = L.tileLayer('https://geo.nls.uk/mapdata2/os/25_inch/london/{z}/{x}/{y}.png', {
      minZoom: 12,
      maxZoom: 18,
      attribution: ''
    }).addTo(map);

    if (isOwner) {
      document.getElementById('ownerControls').style.display = 'block';
    }

    L.control.scale({ metric: true, imperial: false, maxWidth: 200 }).addTo(map);

    const publicMarkers = new L.FeatureGroup().addTo(map);
    const privateMarkers = new L.FeatureGroup();
    if (isOwner) privateMarkers.addTo(map);

    const drawControl = new L.Control.Draw({
      edit: {
        featureGroup: publicMarkers,
        edit: isOwner
      },
      draw: {
        polygon: true,
        polyline: true,
        rectangle: true,
        marker: true,
        circle: false,
        circlemarker: false
      }
    });
    map.addControl(drawControl);

    L.control.layers(null, {
      'Public Markers': publicMarkers,
      ...(isOwner ? { 'Private Markers': privateMarkers } : {})
    }).addTo(map);

    const markerStyles = {
      'alchemicals': { icon: 'flask', markerColor: 'cadetblue' },
      'campsite': { icon: 'home', markerColor: 'blue' },
      'concern': { icon: 'exclamation-triangle', markerColor: 'red' },
      'contact': { icon: 'user', markerColor: 'purple' },
      'district': { icon: 'flag-o', markerColor: 'darkgreen' },
      'doctor': { icon: 'plus-square', markerColor: 'purple' },
      'electriques': { icon: 'tachometer', markerColor: 'cadetblue' },
      'mechaniques': { icon: 'cogs', markerColor: 'cadetblue' },
      'performance site': { icon: 'star', markerColor: 'green' },
      'rumor mill': { icon: 'comments-o', markerColor: 'orange' },
      'ward': { icon: 'shield', markerColor: 'darkred' }
    };

    function getMarkerStyle(type) {
      const key = (type || '').toLowerCase().trim();
      const def = { icon: 'map-marker', markerColor: 'cadetblue' };
      const style = markerStyles[key];
      return L.AwesomeMarkers.icon({ ...(style || def), prefix: 'fa' });
    }

    map.on(L.Draw.Event.CREATED, e => {
      if (e.layerType === 'marker') {
        const type = document.getElementById('typeSelector').value.trim().toLowerCase();
        const isPublic = document.getElementById('visibilityToggle').value === 'public';
        const label = prompt('Enter a label or description for this marker:') || '';
        const icon = getMarkerStyle(type);
        const latlng = e.layer.getLatLng();
        const marker = L.marker(latlng, { icon });
        if (label.trim()) marker.bindPopup(label);

        marker.feature = {
          type: 'Feature',
          properties: {
            popupContent: label,
            markerType: type,
            visibility: isPublic ? 'public' : 'private'
          },
          geometry: { type: 'Point', coordinates: [latlng.lng, latlng.lat] }
        };

        (isPublic ? publicMarkers : privateMarkers).addLayer(marker);
      }
    });

    if (isOwner) {
      privateMarkers.eachLayer(layer => {
        layer.on('contextmenu', () => {
          const currentLabel = layer.getPopup()?.getContent() || '';
          const newLabel = prompt('Edit label before publishing:', currentLabel);
          if (newLabel === null) return;
          if (newLabel.trim()) {
            layer.bindPopup(newLabel.trim());
            layer.feature.properties.popupContent = newLabel.trim();
          }
          privateMarkers.removeLayer(layer);
          publicMarkers.addLayer(layer);
          layer.feature.properties.visibility = 'public';
        });
      });
    }

    function exportGeoJSON() {
      const allMarkers = new L.FeatureGroup();
      publicMarkers.eachLayer(layer => {
        if (layer instanceof L.Marker && layer.feature) {
          allMarkers.addLayer(layer);
        }
      });
      privateMarkers.eachLayer(layer => {
        if (layer instanceof L.Marker && layer.feature) {
          allMarkers.addLayer(layer);
        }
      });
      const json = allMarkers.toGeoJSON();
      const blob = new Blob([JSON.stringify(json, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'data.geojson';
      link.click();
      URL.revokeObjectURL(url);
    }

    fetch('data.geojson')
      .then(response => response.ok ? response.json() : null)
      .then(data => {
        if (data) {
          L.geoJSON(data, {
            pointToLayer: (feature, latlng) => {
              const visibility = feature.properties?.visibility || 'public';
              const isPrivate = visibility === 'private';
              if (isPrivate && !isOwner) return null;

              const icon = getMarkerStyle((feature.properties.markerType || 'default').toLowerCase());
              const marker = L.marker(latlng, { icon });
              if (feature.properties?.popupContent) marker.bindPopup(feature.properties.popupContent);
              marker.feature = feature;
              return marker;
            }
          }).eachLayer(layer => {
            const isPrivate = layer.feature?.properties?.visibility === 'private';

            if (isPrivate) {
              privateMarkers.addLayer(layer);
              if (isOwner) {
                layer.on('click', () => {
                  const currentLabel = layer.getPopup()?.getContent() || '';
                  const newLabel = prompt('Edit label before publishing:', currentLabel);
                  if (newLabel === null) return;
                  if (newLabel.trim()) {
                    layer.bindPopup(newLabel.trim());
                    layer.feature.properties.popupContent = newLabel.trim();
                  }
                  privateMarkers.removeLayer(layer);
                  publicMarkers.addLayer(layer);
                  layer.feature.properties.visibility = 'public';
                });
              }
            } else {
              publicMarkers.addLayer(layer);
            }
          });

    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = function () {
      const div = L.DomUtil.create('div', 'legend');
      for (const key in markerStyles) {
        const { icon, markerColor } = markerStyles[key];
        div.innerHTML +=
          `<div style="margin-bottom:4px;">
            <i class="fa fa-${icon}" style="color:white; background:${markerColor}; border-radius:50%; width:22px; height:22px; line-height:22px; text-align:center; display:inline-block;"></i>
            ${key}
          </div>`;
      }
      return div;
    };
    legend.addTo(map);
  </script>
</body>
</html>
