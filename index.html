<!DOCTYPE html>
<html>
<head>
  <title>Victorian London Map (Interactive)</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.awesome-markers/2.0.4/leaflet.awesome-markers.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    .leaflet-top.leaflet-right { top: 70px; }
    #exportBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      padding: 6px 10px;
      background: white;
      border: 1px solid #666;
      font-size: 14px;
      cursor: pointer;
    }
    #typeSelector {
      position: absolute;
      top: 10px;
      left: 60px;
      z-index: 1000;
      background: white;
      border: 1px solid #666;
      padding: 5px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <select id="typeSelector">
    <option value="campsite">Campsite</option>
    <option value="performance site">Performance Site</option>
    <option value="concern">Concern</option>
    <option value="contact">Contact</option>
    <option value="rumor mill">Rumor Mill</option>
    <option value="doctor">Doctor</option>
    <option value="electriques">Electriques</option>
    <option value="mechaniques">Mechaniques</option>
    <option value="alchemicals">Alchemicals</option>
    <option value="wardings">Wardings</option>
    <option value="district">District</option>
  </select>
  <div id="map"></div>
  <button id="exportBtn" onclick="exportGeoJSON()">Export GeoJSON</button>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.awesome-markers/2.0.4/leaflet.awesome-markers.js"></script>

  <script>
    const map = L.map('map').setView([51.5074, -0.1278], 13);
    L.tileLayer('https://api.maptiler.com/tiles/uk-osgb10k1888/{z}/{x}/{y}.jpg?key=r0HKkxDJMfqlCVzaro7d', {
      tileSize: 256,
      minZoom: 0,
      maxZoom: 18,
      attribution: '&copy; <a href="https://www.maptiler.com/copyright/">MapTiler</a> &copy; <a href="https://maps.nls.uk/">NLS</a>'
    }).addTo(map);

    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    const drawControl = new L.Control.Draw({
      edit: { featureGroup: drawnItems },
      draw: {
        polygon: true,
        polyline: true,
        rectangle: true,
        marker: true,
        circle: false,
        circlemarker: false
      }
    });
    map.addControl(drawControl);

    const markerStyles = {
      'campsite':      { icon: 'home', markerColor: 'blue' },
      'performance site': { icon: 'ticket', markerColor: 'green' },
      'concern':       { icon: 'exclamation-triangle', markerColor: 'darkred' },
      'contact':       { icon: 'user', markerColor: 'darkgreen' },
      'rumor mill':    { icon: 'comments-o', markerColor: 'orange' },
      'doctor':        { icon: 'plus-square', markerColor: 'gray' },
      'electriques':   { icon: 'tachometer', markerColor: 'purple' },
      'mechaniques':   { icon: 'gears', markerColor: 'purple' },
      'alchemicals':   { icon: 'flask', markerColor: 'purple' },
      'wardings':      { icon: 'shield', markerColor: 'purple' },
      'district':      { icon: 'flag-o', markerColor: 'purple' }
    };

    function getMarkerStyle(type) {
      const key = (type || '').toLowerCase();
      const def = { icon: 'map-marker', markerColor: 'cadetblue' };
      const style = markerStyles[key];
    
      if (!style) {
        console.error(`Unknown marker type: '${key}'`);
        return L.AwesomeMarkers.icon({ ...def, prefix: 'fa' });
      }
    
      return L.AwesomeMarkers.icon({ ...style, prefix: 'fa' });
    }

    map.on(L.Draw.Event.CREATED, e => {
  if (e.layerType === 'marker') {
    const typeSelector = document.getElementById('typeSelector');
    if (!typeSelector || !typeSelector.value.trim()) {
      alert("You must select a marker type before placing it.");
      return;
    }

    const label = prompt("Enter a label or description for this marker:") || '';
    const type = typeSelector.value.trim().toLowerCase();
    const icon = getMarkerStyle(type);
    const latlng = e.layer.getLatLng();
    const marker = L.marker(latlng, { icon });

    if (label.trim() !== '') marker.bindPopup(label);

    marker.feature = {
      type: 'Feature',
      properties: {
        popupContent: label,
        markerType: type
      },
      geometry: {
        type: 'Point',
        coordinates: [latlng.lng, latlng.lat]
      }
    };

    drawnItems.addLayer(marker);
  } else {
    drawnItems.addLayer(e.layer);
  }
});

    function exportGeoJSON() {
      const json = drawnItems.toGeoJSON();
      json.features.forEach(f => {
        drawnItems.eachLayer(layer => {
          if (layer instanceof L.Marker) {
            const latlng = layer.getLatLng();
            const [lng, lat] = f.geometry.coordinates;
            const samePoint = Math.abs(latlng.lat - lat) < 0.00001 && Math.abs(latlng.lng - lng) < 0.00001;
            if (samePoint) {
              const popup = layer.getPopup();
              if (popup) f.properties.popupContent = popup.getContent();
              f.properties.markerType = layer.feature?.properties?.markerType || "default";
            }
          }
        });
      });

      const blob = new Blob([JSON.stringify(json, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'data.geojson';
      link.click();
      URL.revokeObjectURL(url);
    }

    fetch('data.geojson')
      .then(response => response.ok ? response.json() : null)
      .then(data => {
        if (data) {
          L.geoJSON(data, {
            pointToLayer: (feature, latlng) => {
              const icon = getMarkerStyle((feature.properties.markerType || "default").toLowerCase());
              const marker = L.marker(latlng, { icon });
              if (feature.properties && feature.properties.popupContent) {
                marker.bindPopup(feature.properties.popupContent);
              }
              marker.feature = feature;
              return marker;
            }
          }).eachLayer(layer => drawnItems.addLayer(layer));
        }
      });
  </script>
</body>
</html>
